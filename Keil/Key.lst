C51 COMPILER V9.01   KEY                                                                   07/20/2018 09:06:28 PAGE 1   


C51 COMPILER V9.01, COMPILATION OF MODULE KEY
OBJECT MODULE PLACED IN .\Key.obj
COMPILER INVOKED BY: D:\Kell\C51\BIN\C51.EXE ..\Src\Key.c BROWSE DEBUG OBJECTEXTEND PRINT(.\Key.lst) OBJECT(.\Key.obj)

line level    source

   1          #include "RM.h"
   2          #include "Key.h"
   3          
   4          #define KEY_STATE_UNPRESSED     0x00            //æŒ‰é”®çŠ¶æ€ï¼šæ²¡æœ‰æŒ‰ä¸‹
   5          #define KEY_STATE_DEBOUNCE      0x01            //æŒ‰é”®çŠ¶æ€ï¼šæŒ‰ä¸‹ï¼Œä½†æŒ‰ä¸‹æ—¶é—´ä¸è¶³ï¼Œå¯èƒ½è¿˜åœ¨é¢¤åŠ¨ï¼Œå›
             - æ­¤ç°åœ¨æ¬¡çŠ¶æ€ç­‰å€™ä¸€æ®µæ—¶é—´
   6          #define KEY_STATE_PRESSED   0x02                //æŒ‰é”®çŠ¶æ€ï¼šç¡®å®šæŒ‰é”®æŒ‰ä¸‹å¹¶ç¨³å®šï¼Œåœ¨æ­¤çŠ¶æ€ä¸‹åŒºåˆ†çŸ­æ
             -Œ‰å’Œé•¿æŒ‰
   7          #define KEY_STATE_WAITLOOSE 0x03                //æŒ‰é”®çŠ¶æ€ï¼šç­‰å¾…é•¿æŒ‰åæ¾åä¼šåˆ°æ²¡æœ‰æŒ‰ä¸‹çŠ¶æ€
   8          
   9          //////////////////////////////////////////////////////////////////////////////////////////////////
  10          //TODO:æ—¶é•¿è¿˜æœ‰å¾…è°ƒè¯•ç¡®å®šï¼Œå¦‚æœæœ‰éœ€è¦DECOUNCE_TIMEç½®ä¸º0ï¼ŒLONG_PRESS_TIMEç½®ä¸ºæ— ç©·ï¼Œå
             -–æ¶ˆæ¶ˆé¢¤å’Œé•¿æŒ‰åŠŸèƒ½ //
  11          /////////////////////////////////////////////////////////////////////////////////////////////////
  12          #define DECOUNCE_TIME 50                                //50æ¬¡KeyScanå®Œæˆæ¶ˆé¢¤(åŸºäºè®¤ä¸ºä¸¤æ¬¡KeyScanç›¸è·50ä¸ªæœºå™¨å‘¨æœŸï¼Œ
             -è°ƒæ•´ï¼)
  13          #define LONG_PRESS_TIME 60000                   //60000æ¬¡KeyScanåˆ¤å®šä¸ºé•¿æŒ‰
  14          
  15          sbit key1=P1^5;                                         //å¤–éƒ¨å…¨å±€å˜é‡ï¼Œè§main.c
  16          sbit key2=P1^4;
  17          sbit key3=P1^3;
  18          
  19          extern uchar key1Events;                                //å¤–éƒ¨å…¨å±€å˜é‡ï¼Œè§main.c
  20          extern uchar key2Events;
  21          extern uchar key3Events;
  22          
  23          extern bit isKeyEvents;                                 //å¤–éƒ¨å…¨å±€å˜é‡ï¼Œè§main.c
  24          
  25          uchar key1State;                                                //è®°å½•å„ä¸ªæŒ‰é”®çŠ¶æ€
  26          uchar key2State;
  27          uchar key3State;
  28          
  29          uint key1Timer;                                                 //å„ä¸ªæŒ‰é”®çš„è®¡æ—¶å™¨ï¼Œç”¨åœ¨æ¶ˆé¢¤å’Œé•¿æŒ‰åˆ¤æ–­ä¸Š
  30          uint key2Timer;
  31          uint key3Timer;
  32          
  33          /**
  34           * é€ä¸ªæ‰«ææŒ‰é”®ï¼Œå¹¶æŠŠæŒ‰é”®æ‰«æç»“æœï¼ˆæ— åŠ¨ä½œï¼Œé•¿æŒ‰ï¼ŒçŸ­æŒ‰ï¼‰æ”¾åˆ°keyxEventså…¨å±€å˜
             -é‡ä¸­ç­‰å¾…å¤„ç†
  35           * @Author   Xiaobo     Yang
  36           * @DateTime 2018-07-16
  37           * @Summury
  38           */
  39          void KeyScan(){
  40   1              switch(key1State){                                                                              //é€‰æ‹©çŠ¶æ€                                  
  41   2                      case KEY_STATE_UNPRESSED:                                                       //æ²¡æœ‰æŒ‰ä¸‹çŠ¶æ€    
  42   2                              if(!key1) {                                                                             //æŒ‰é”®æŒ‰ä¸‹ï¼ˆä½ç”µå¹³ï¼‰ï¼Œè½¬ç§»åˆ°æ¶ˆé¢¤çŠ¶æ€
  43   3                                      key1State=KEY_STATE_DEBOUNCE;
  44   3                                      key1Timer=0;                                                            //åˆå§‹åŒ–è®¡æ—¶å™¨
  45   3                              }
  46   2                              break;
  47   2                      case KEY_STATE_DEBOUNCE:                                                        //æ¶ˆé¢¤çŠ¶æ€
  48   2                              if(key1) {                                                                              //æŒ‰é”®æ¾å¼€ï¼Œè¯´æ˜è¿˜åœ¨é¢¤åŠ¨ï¼Œå›åˆ°æ²¡æœ‰æŒ‰ä¸‹çŠ¶æ€
  49   3                                      key1State=KEY_STATE_UNPRESSED;                                  
  50   3                              }
C51 COMPILER V9.01   KEY                                                                   07/20/2018 09:06:28 PAGE 2   

  51   2                              else if(++key1Timer>DECOUNCE_TIME){                             //æŒ‰é”®æŒ‰ä¸‹ï¼Œå°±è®¡æ•°ï¼Œè‹¥æŒ‰ä¸‹æ—¶é•¿è¶³å¤Ÿï¼Œè¯´æ˜æŒ‰é”
             -®ç¨³å®šï¼Œè½¬å…¥æŒ‰ä¸‹çŠ¶æ€
  52   3                                      key1State=KEY_STATE_PRESSED;                            
  53   3                                      key1Timer=0;                                                            //é‡è®¾è®¡æ—¶å™¨
  54   3                              }
  55   2                              break;
  56   2                      case KEY_STATE_PRESSED:
  57   2                              if(key1){                                                                               //å¦‚æœæŒ‰é”®æ¾å¼€ï¼ŒæŒ‰ä¸‹æ—¶é—´åˆä¸å¤Ÿï¼Œå°±ç»™å‡ºçŸ­æŒ‰äº‹ä»¶ï¼Œå¹¶è½¬ç§»åˆ°æ
             -œªæŒ‰ä¸‹çŠ¶æ€
  58   3                                      key1State=KEY_STATE_UNPRESSED;
  59   3                                      key1Events=SHORT_PRESS;
  60   3                                      isKeyEvents=1;                                                          //å‘Šè¯‰ä¸»ç¨‹åºæœ‰æŒ‰é”®äº‹ä»¶å‘ç”Ÿ
  61   3                              }
  62   2                              else if(++key1Timer>LONG_PRESS_TIME){                   //å¦‚æœæŒ‰é”®æ²¡æœ‰æ¾å¼€ï¼Œè®¡æ—¶ï¼Œè¶³å¤Ÿé•¿åå‘å‡ºé•¿æŒ‰ä
             -º‹ä»¶ï¼Œè½¬ç§»åˆ°ç­‰å¾…æ¾æ‰‹çŠ¶æ€
  63   3                                      key1Events=LONG_PRESS;
  64   3                                      isKeyEvents=1;                                                          //å‘Šè¯‰ä¸»ç¨‹åºæœ‰æŒ‰é”®äº‹ä»¶å‘ç”Ÿ
  65   3                                      key1State=KEY_STATE_WAITLOOSE;
  66   3                              }
  67   2                              break;
  68   2                      case KEY_STATE_WAITLOOSE:
  69   2                              if(key1) key1State=KEY_STATE_UNPRESSED;                 //ä¸€æ—¦æ¾æ‰‹ï¼Œå°±ä¼šåˆ°æœªæŒ‰ä¸‹çŠ¶æ€
  70   2                              break;
  71   2              }
  72   1      
  73   1              switch(key2State){                                                                              //å‚è§key1Stateéƒ¨åˆ†æ³¨é‡Š
  74   2                      case KEY_STATE_UNPRESSED:
  75   2                              if(!key2) {
  76   3                                      key2State=KEY_STATE_DEBOUNCE;
  77   3                                      key2Timer=0;
  78   3                              }
  79   2                              break;
  80   2                      case KEY_STATE_DEBOUNCE:
  81   2                              if(key2) {
  82   3                                      key2State=KEY_STATE_UNPRESSED;
  83   3                              }
  84   2                              else if(++key2Timer>DECOUNCE_TIME){
  85   3                                      key2State=KEY_STATE_PRESSED;
  86   3                                      key2Timer=0;
  87   3                              }
  88   2                              break;
  89   2                      case KEY_STATE_PRESSED:
  90   2                              if(key2){
  91   3                                      key2State=KEY_STATE_UNPRESSED;
  92   3                                      key2Events=SHORT_PRESS;
  93   3                                      isKeyEvents=1;
  94   3                              }
  95   2                              else if(++key2Timer>LONG_PRESS_TIME){
  96   3                                      key2Events=LONG_PRESS;
  97   3                                      isKeyEvents=1;
  98   3                                      key2State=KEY_STATE_WAITLOOSE;
  99   3                              }
 100   2                              break;
 101   2                      case KEY_STATE_WAITLOOSE:
 102   2                              if(key2) key2State=KEY_STATE_UNPRESSED;
 103   2                              break;
 104   2              }
 105   1      
 106   1              switch(key3State){                                                                              //å‚è§key1Stateéƒ¨åˆ†æ³¨é‡Š
 107   2                      case KEY_STATE_UNPRESSED:
 108   2                              if(!key3) {
 109   3                                      key3State=KEY_STATE_DEBOUNCE;
C51 COMPILER V9.01   KEY                                                                   07/20/2018 09:06:28 PAGE 3   

 110   3                                      key3Timer=0;
 111   3                              }
 112   2                              break;
 113   2                      case KEY_STATE_DEBOUNCE:
 114   2                              if(key3) {
 115   3                                      key3State=KEY_STATE_UNPRESSED;
 116   3                              }
 117   2                              else if(++key3Timer>DECOUNCE_TIME){
 118   3                                      key3State=KEY_STATE_PRESSED;
 119   3                                      key3Timer=0;
 120   3                              }
 121   2                              break;
 122   2                      case KEY_STATE_PRESSED:
 123   2                              if(key3){
 124   3                                      key3State=KEY_STATE_UNPRESSED;
 125   3                                      key3Events=SHORT_PRESS;
 126   3                                      isKeyEvents=1;
 127   3                              }
 128   2                              else if(++key3Timer>LONG_PRESS_TIME){
 129   3                                      key3Events=LONG_PRESS;
 130   3                                      isKeyEvents=1;
 131   3                                      key3State=KEY_STATE_WAITLOOSE;
 132   3                              }
 133   2                              break;
 134   2                      case KEY_STATE_WAITLOOSE:
 135   2                              if(key3) key3State=KEY_STATE_UNPRESSED;
 136   2                              break;
 137   2              }
 138   1      }
 139          /**
 140           * å®ŒæˆæŒ‰é”®ä¿¡å·å¤„ç†åï¼Œåº”è¯¥è°ƒç”¨è¯¥å‡½æ•°åŠæ—¶æ¸…ç†æ‰ä¸Šä¸€æ¬¡æŒ‰é”®æ‰«æå–å¾—çš„äº‹ä»¶
 141           * @Author   Xiaobo     Yang
 142           * @DateTime 2018-07-18
 143           * @Summury æ³¨æ„ï¼Œåœ¨æœ¬ç¨‹åºä¸­ï¼Œåªæœ‰æŒ‰é”®ä¿¡å·è¢«å¤„ç†åï¼Œæ‰ä¼šè¿›è¡Œä¸‹ä¸€æ¬¡KeyScanå¼•å…¥
             -æ–°çš„äº‹ä»¶ã€‚
 144           * è€Œå·²å¤„ç†æŒ‰é”®äº‹ä»¶è¦åŠæ—¶resetæ‰ï¼Œæ‰èƒ½è®©æ¯æ¬¡KeyScanäº’ä¸ç›¸æ‰°ã€‚
 145           */
 146          void RstKeyEvents(){
 147   1              key1Events=NONE_PRESS;
 148   1              key2Events=NONE_PRESS;
 149   1              key3Events=NONE_PRESS;
 150   1              isKeyEvents=NONE_PRESS;
 151   1      }
 152          /**
 153           * åˆå§‹åŒ–æŒ‰é”®çŠ¶æ€ï¼Œç”¨äºè½¯é‡ç½®
 154           * @Author   Xiaobo     Yang
 155           * @DateTime 2018-07-18
 156           * @Summury ç”±äºé‡ç½®æŒ‰é’®è¢«å ç”¨ï¼Œå› æ­¤é‡‡ç”¨è½¯é‡ç½®å‡½æ•°ï¼Œè½¯é‡ç½®æ—¶è¦é‡è®¾æ‰€æœ‰å’Œkeyx
             -æœ‰å…³å˜é‡
 157           */
 158          void KeyInitial(){
 159   1              key1Events=NONE_PRESS;
 160   1              key2Events=NONE_PRESS;
 161   1              key3Events=NONE_PRESS;
 162   1              isKeyEvents=NONE_PRESS;
 163   1              key1State=KEY_STATE_UNPRESSED;
 164   1              key2State=KEY_STATE_UNPRESSED;
 165   1              key3State=KEY_STATE_UNPRESSED;
 166   1              key1Timer=0;
 167   1              key2Timer=0;
 168   1              key3Timer=0;
 169   1      }
C51 COMPILER V9.01   KEY                                                                   07/20/2018 09:06:28 PAGE 4   

 170          /**
 171           * æˆ‘ä¹Ÿä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦å†™è¿™ä¸ªå‡½æ•°ï¼Œæ„Ÿè§‰å¾ˆå¥½ç©çš„æ ·å­
 172           */
 173          void WaitKey(void (*key1Fun) (void),void (*key2Fun) (void),void (*key3Fun) (void)){
 174   1              while(!isKeyEvents) KeyScan();
 175   1              if(key1Events) (*key1Fun) ();
 176   1              if(key2Events) (*key2Fun) ();
 177   1              if(key3Events) (*key3Fun) ();
 178   1              RstKeyEvents();
 179   1      }
 180          /**
 181           * æŒ‰ä¸‹ä»»æ„é”®ï¼Œå¦åˆ™é˜»å¡
 182           * @Author   Xiaobo     Yang
 183           * @DateTime 2018-07-19
 184           * @Summury
 185           */
 186          void PressAnyKey(){
 187   1              while(!isKeyEvents) KeyScan();
 188   1              RstKeyEvents();
 189   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    427    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      9       9
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
